07 스프링 부트 배치 실전
======================= 
# 3. 스프링 부트 휴면회원 배치 설계하기    
커뮤니티에 가입한 회원 중 1년이 지나도록 상태 변화가 없는 회원을 휴면 회원으로 전환하는 배치를 만들겠습니다.   
Job 과 Step을 모두 사용해 구조를 만들겁니다.   

Job, Step은 개발자가 어떻게 구성하느냐에 따라 아주 간단한 로직일 수도 있고 복잡한 비즈니스 로직을 담을 수도 있습니다.   
최대한 간단한 로직을 담은 배치를 구성해봅시다.   
   
[사진]    
    
1. H2 DB에 저장된 데이터 중 1년간 업데이트되지 않은 사용자를 찾는 로직을 ItemReader로 구현합니다. (찾기)  
2. 대상 사용자 데이터의 상탯값을 휴면회원으로 전환하는 프로세서를 ItemProcessor에 구현합니다. (변환)  
3. 상탯값이 변한 휴면회원을 실제로 DB에 저장하는 ItemWriter를 구현합니다. (저장)  

[사진]   

***
# 4. 스프링 부트 배치 설정하기   
먼저 배치 프로젝트를 생성합니다.   
   
* 프로젝트명 : Spring-Boot-Community-Batch   
* 그룹 : com.community  

**build.gradle**
```gradle   
buildscript {
    ext{
        springBootVersion = '2.0.3.RELEASE'
    }
    repositories {
        mavenCentral()
        jcenter()
    }
    dependencies {
        classpath("org.springframework.boot:spring-boot-gradle-plugin:${springBootVersion}")
    }
}

apply plugin: 'java'
apply plugin: 'eclipse'
apply plugin: 'org.springframework.boot'
apply plugin: 'io.spring.dependency-management'

group = 'com.community'
version = '0.0.1-SNAPSHOT'
sourceCompatibility = 1.8

repositories {
    mavenCentral()
    jcenter()
}

dependencies {
    compile('org.springframework.boot:spring-boot-starter-batch')
    compile('org.springframework.boot:spring-boot-starter-data-jpa')
    runtime('com.h2database:h2')
    compileOnly('org.projectlombok:lombok')
    testCompile('org.springframework.batch:spring-batch-test')
    testCompile('org.springframework.boot:spring-boot-starter-test')
}

test {
    useJUnitPlatform()
}    
```
스프링 부트 배치 스타터를 사용하면 배치 생성에 필요한 많은 설정을 자동으로 적용할 수 있습니다.                 
배치 처리에 대부분에 대해 테스트를 실행해봐야 하므로 ```spring-boot-starter-test```도 추가해줍니다.         
     
___
   
휴면회원 배치 처리에 사용될 도메인을 설정합니다.        
앞서 사용했던 User 객체를 그대로 가져옵니다.         
**다만 휴면 여부를 판별하는 UserState Enum을 추가해줍니다.**       
ACTIVE 는 활성회원,
INACTIVE 는 휴면회원입니다.    
SocialType Enum은 앞서 진행한 코드와 동일합니다.    
    
**UserStatus.enum**
```java
package com.community.batch.domain.enums;

public enum UserStatus {
    ACTIVE, INACTIVE
}
```

**Grade.enum**
```java
package com.community.batch.domain.enums;

public enum Grade {
    VIP, GOLD, FAMILY
}
```

**SocialType.enum**
```java
package com.community.batch.domain.enums;

public enum SocialType {
    FACEBOOK("facebook"),
    GOOGLE("google"),
    KAKAO("kakao");

    private final String ROLE_PREFIX = "ROLE_";
    private String name;

    SocialType(String name){
        this.name = name;
    }

    public String getRoleType(){
        return ROLE_PREFIX + name.toUpperCase();
    }

    public String getValue(){return name;}

    public boolean isEquals(String authority){
        return this.getRoleType().equals(authority);
    }
}
```

**User**
```java
package com.community.batch.domain;

import com.community.batch.domain.enums.Grade;
import com.community.batch.domain.enums.SocialType;
import com.community.batch.domain.enums.UserStatus;
import lombok.Builder;
import lombok.EqualsAndHashCode;
import lombok.Getter;
import lombok.NoArgsConstructor;

import javax.persistence.*;
import java.io.Serializable;
import java.time.LocalDateTime;

@Getter
@EqualsAndHashCode(of = {"idx", "email"})
@NoArgsConstructor
@Entity
@Table
public class User implements Serializable {

    @Id
    @Column
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long idx;

    @Column
    private String name;

    @Column
    private String password;

    @Column
    private String email;

    @Column
    private String principal;

    @Column
    @Enumerated(EnumType.STRING)
    private SocialType socialType;

    @Column
    @Enumerated(EnumType.STRING)
    private UserStatus status;

    @Column
    @Enumerated(EnumType.STRING)
    private Grade grade;

    @Column
    private LocalDateTime createdDate;

    @Column
    private LocalDateTime updateDate;

    @Builder
    public User(String name, String password, String email, String principal, SocialType socialType, UserStatus status ,LocalDateTime createdDate, LocalDateTime updateDate) {
        this.name = name;
        this.password = password;
        this.email = email;
        this.principal = principal;
        this.socialType = socialType;
        this.status = status;
        this.createdDate = createdDate;
        this.updateDate = updateDate;
    }

    public User setInactive(){
        status = UserStatus.INACTIVE;
        return this;
    }
}
```
   
___
    
```java
@EqualsAndHashCode(of = {"idx", "email"})
```
객체의 동등성을 비교하는 Equals() 와 HashCode() 메서드를 구현하는 어노테이션인 ```@EqualsAndHashCode```를 추가했습니다.   
비교할 필드값으로 유니크 값인 idx와 email을 설정했습니다.   
        
___
     
```java
    @Column
    @Enumerated(EnumType.STRING)
    private UserStatus status;
```
UserStatus 관련 Enum 필드를 추가합니다.      
        
___
    
```java
    @Column
    @Enumerated(EnumType.STRING)
    private Grade grade;
```
회원의 등급을 나타내는 Grade Enum 필드를 추가했습니다.   
   
___
      
```java
    public User setInactive(){
        status = UserStatus.INACTIVE;
        return this;
    }
```
User가 휴면회원으로 판정된 경우 status 필드값을 휴면으로 전환하는 메서드를 추가했습니다.      
  
***  
# 5. 스프링 부트 휴면회원 배치 구현하기    
    
**구현 순서**   
1. 휴면회원 배치 테스트 코드 생성   
2. 휴면회원 배치 정보 설정   
3. SQL로 테스트 데이터 주입하기   

## 5.1. 휴면회원 배치 테스트 코드 생성  
먼저 JobLauncherTestUtils를 빈으로 등록해 테스트 설정 클래스를 작성합니다.      
JobLauncherTestUtils는 배치의 Job을 실행해 테스트하는 유틸리티 클래스입니다.     

* ```/test/java/com/community/batch``` 에서 TestJobConfig 클래스 작성 

**TestJobConfig**
```java
package com.community.batch;

import org.springframework.batch.core.configuration.annotation.EnableBatchProcessing;
import org.springframework.batch.test.JobLauncherTestUtils;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;

@EnableBatchProcessing
@Configuration
public class TestJobConfig {

    @Bean
    public JobLauncherTestUtils jobLauncherTestUtils(){
        return new JobLauncherTestUtils();
    }
}
```       
참고로 이렇게 메서드를 만들고 리턴하는 방법은 사용자가 직접 제어할 수 없는 외부라이브러리르들을 빈등록 할 때 사용하고        
```@Bean``` 어노테이션도 마찬가지로 클래스 외부에 선언하는 ```@Component``` 대신 이러한 클래스들을 등록하기 위해서 사용되는 것이다.          
그리고 ```@Configuration```은 ```@Bean```등록한 객체를 싱글톤 형태로 보장해준다. (```@Component```는 보장 안한다는 말이기도 하다)           
    
참고 :   
1. https://galid1.tistory.com/494
2. https://taes-k.github.io/2019/11/22/spring-component-configuration/    
   
___

```java
@EnableBatchProcessing
```
```@EnableBatchProcessing```은 스프링 부트 배치 스타터에 미리 정의된 설정들을 실행시키는 마법의 어노테이션입니다.   
배치에 필요한 JobBuilder, StepBuilder, JobRepository, JobLauncher 등 다양한 설정이 자동으로 주입됩니다.   
     
___
    

```java
    @Bean
    public JobLauncherTestUtils jobLauncherTestUtils(){
        return new JobLauncherTestUtils();
    }
```
Job이 실행에 필요한 JobLauncher를 필드값으로 갖는 JobLauncherTestUtils를 빈으로 등록합니다.     

___
   
휴면회원 전환 기능을 구현하기 전에 후면 전환이 오바르게 되었는지 확인하는 테스트 코드를 먼저 작성합니다.   

**InactiveUserJobTest**
```java

```

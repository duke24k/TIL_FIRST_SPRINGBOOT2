05_02 스프링 부트 2.0 기반의 OAuth2 설정
=======================

# 스프링 부트 2.0 기반의 OAuth2 설정
스프링 부트 2.0 버전에서부터는 시큐리티와 OAuth2 인증 부분에 많은 변화가 생겼습니다.   
기존 1.5 버전 코드에서 업그레이드 하면서 알아봅시다.   

# 1. 스프링 부트 2.0 버전으로 의존성 업그레이드      
스프링 부트의 장점은 빠른 버전 업그레이드가 가능하다는 것 입니다.    
기존의 ```build.gradle``` 파일에서 ```springBootVersion = '1.5.14.RELEASE'``` 에서 버전만 바꿔주면 됩니다.    

**build.gradle**   
```gradle
buildscript {
	ext{
		springBootVersion = '2.0.3.RELEASE'
	}
	repositories {
		mavenCentral()
		jcenter()
	}
	dependencies {
		classpath("org.springframework.boot:spring-boot-gradle-plugin:${springBootVersion}")
	}
}

apply plugin: 'java'
apply plugin: 'eclipse'
apply plugin: 'org.springframework.boot'
apply plugin: 'io.spring.dependency-management'

group = 'com.web'
version = '0.0.1-SNAPSHOT'
sourceCompatibility = 1.8

.
. ~ 생략 ~ 
.  
``` 
```gradle
		springBootVersion = '2.0.3.RELEASE'
```
스프링 부트 버전을 2.0.3 RELEASE 로 수정했습니다.     
     
```gradle
apply plugin: 'io.spring.dependency-management'
```
2.0 이후부터는 더 이상 ```dependency-management``` 플러그인을 자동으로 지원하지 않기 때문에 수동으로 추가해줘야 합니다.            
```dependency-management``` 플러그인은 그레이들에서 의존성 관리 제어를 위해 필요한 플러그인입니다.         
    
___      
    
이번에는 라이브러리 의존성들을 2.0 버전에 맞춰서 업그레이드 시켜주겠습니다. (버전이 아닌 필요 라이브러리 변경)    

**build.gradle**   
```gradle   
.
. ~ 생략 ~ 
.
dependencies {
	compile('org.springframework.security:spring-security-oauth2-client')
	compile('org.springframework.security:spring-security-oauth2-jose')
	compile('org.springframework.boot:spring-boot-starter-security')
	compile('org.springframework.boot:spring-boot-starter-web')
	compile('org.springframework.boot:spring-boot-starter-thymeleaf')
	compile('org.springframework.boot:spring-boot-starter-data-jpa')
	runtime('com.h2database:h2')
	runtime('org.springframework.boot:spring-boot-devtools')
	compileOnly('org.projectlombok:lombok')
	testCompile('org.springframework.boot:spring-boot-starter-test')
}
.
. ~ 생략 ~ 
.
```
기존에는 ```compile('org.springframework.security.oauth:spring-security-oauth2')``` 가 있으면 괜찮았지만      
2.0 으로 넘어오고 나서는 설정이 세분화 되었습니다.              
기본적인 OAuth2 인증 관련 객체들이 시큐리티로 이전되었습니다.       
   
* 2.0 에서는 **클라이언트 자동 인증 설정**을 위해 ```spring-security-oauth2-client``` 를 추가합니다.          
* 2.0 에서는 **JWT 와 관련한 권한을 안전하게 전송**하기 위한 프레임 워크인 ```JOSE```가 추가되었습니다.            
JWT에는 자신의 리소스에 접근할 수 있는 권한 정보가 들어있는데 JOSE는 JWT의 암호화/복호화 및 일정한 기능을 제공합니다.        

```
1.5 버전에서는 타임리프에 spring-boot-starter-web 에 대한 설정도 포함되어 있었지만 2.0 부터는 포함되지 않아 추가했습니다.    
또한 2.0 부터는 타임리프의 java8time 설정이 타임리프 스타터 설정에 포함되었기 떼문에 제거했습니다.   
- 필자 정리를 보신분들은 의아하실 수 있는데 저는 애초에 starter 로 해서 해당 내용이 없습니다.    
```

**전체 build.gradle**
```gradle
buildscript {
	ext{
		springBootVersion = '2.0.3.RELEASE'
	}
	repositories {
		mavenCentral()
		jcenter()
	}
	dependencies {
		classpath("org.springframework.boot:spring-boot-gradle-plugin:${springBootVersion}")
	}
}

apply plugin: 'java'
apply plugin: 'eclipse'
apply plugin: 'org.springframework.boot'
apply plugin: 'io.spring.dependency-management'

group = 'com.web'
version = '0.0.1-SNAPSHOT'
sourceCompatibility = 1.8

repositories {
	mavenCentral()
	jcenter()
}

dependencies {
	compile('org.springframework.security:spring-security-oauth2-client')
	compile('org.springframework.security:spring-security-oauth2-jose')
	compile('org.springframework.boot:spring-boot-starter-security')
	compile('org.springframework.boot:spring-boot-starter-web')
	compile('org.springframework.boot:spring-boot-starter-thymeleaf')
	compile('org.springframework.boot:spring-boot-starter-data-jpa')
	runtime('com.h2database:h2')
	runtime('org.springframework.boot:spring-boot-devtools')
	compileOnly('org.projectlombok:lombok')
	testCompile('org.springframework.boot:spring-boot-starter-test')
}

test {
	useJUnitPlatform()
}    
```

# 2. 스프링 부트 2.0 방식의 OAuth2 인증 재설정    
2.0 버전으로 라이브러리들을 변경해주었기 때문에 기존 코드들에 많은 부분이 에러가 나게 될 것입니다.       
그렇기에 이제 기존 코드를 2.0 버전에 맞춰서 변경해주는 작업을 진행해주갰습니다.         
    
**먼저 2.0 버전에서 제거된 객체를 삭제하겠습니다.**     
```spring-security-oauth2``` 를 의존성 제거했기 대문에 다음의 관련 객체들을 삭제합니다.   
```   
/com/web/oauth/ClientResources.java
/com/web/oauth/UserTokenService.java   
```    
이제 새롭게 소셜 정보를 제공해줄 객체를 생성하겠습니다.    
시큐리티의 OAuth2 스펙에서는 여러 소셜 정보를 기본값으로 제공해주고 있습니다.      

```org.springframework.security:spring-security-config:5.0.6.RELEASE``` 라이브러리의 
```org.springframework.security.config.oauth2.client``` 디렉토리의 ```CommonOAuth2Provider``` enum 을 살펴봅시다   

**CommonOAuth2Provider**
```java
	GOOGLE {

		@Override
		public Builder getBuilder(String registrationId) {
			ClientRegistration.Builder builder = getBuilder(registrationId,
					ClientAuthenticationMethod.BASIC, DEFAULT_LOGIN_REDIRECT_URL);
			builder.scope("openid", "profile", "email");
			builder.authorizationUri("https://accounts.google.com/o/oauth2/v2/auth");
			builder.tokenUri("https://www.googleapis.com/oauth2/v4/token");
			builder.jwkSetUri("https://www.googleapis.com/oauth2/v3/certs");
			builder.userInfoUri("https://www.googleapis.com/oauth2/v3/userinfo");
			builder.userNameAttributeName(IdTokenClaimNames.SUB);
			builder.clientName("Google");
			return builder;
		}
	},

	FACEBOOK {

		@Override
		public Builder getBuilder(String registrationId) {
			ClientRegistration.Builder builder = getBuilder(registrationId,
					ClientAuthenticationMethod.POST, DEFAULT_LOGIN_REDIRECT_URL);
			builder.scope("public_profile", "email");
			builder.authorizationUri("https://www.facebook.com/v2.8/dialog/oauth");
			builder.tokenUri("https://graph.facebook.com/v2.8/oauth/access_token");
			builder.userInfoUri("https://graph.facebook.com/me");
			builder.userNameAttributeName("id");
			builder.clientName("Facebook");
			return builder;
		}
	},
... ~ 생략 ~   
```   
구글, 페이스북은 물론 깃허브, okta 에 대한 기본 정보는 스프링 부트 시큐리티 OAuth2 API 에서 제공합니다.          
즉, 1.5 버전의 oauth 관련 프로퍼티를 등록했던 부분을 스프링 부트 시큐리티 OAuth2 API 가 상당 수 제공해줍니다.      
그러므로 우리는 ID와 Secret(password)만 등록해주면 됩니다.        
ID와 Secret 을 프로퍼티 등록을 해줍시다.      
   
**application.yml**   
```yml
spring:
  #  datasource:
  #    url: jdbc:mysql://
  #    username:
  #    password:
  #    driver-class-name: com.mysql.jdbc.Driver
  jpa:
    hibernate:
      ddl-auto: create
  h2:
    console:
      enabled: true
  devtools:
    livereload:
      enabled: true
  thymeleaf:
    cache: false
  security:
    oauth2:
      client:
        registration:
          google:
            client-id: [googleId]
            client-secret: [googleSecret]
          facebook:
            client-id: [facebookId]
            client-secret: [facebookSecret]
```    
추가로 부가적인 다른 설정도 해주었습니다. (h2 사용, 캐시 미사용, db 초기화, jsp/css 변경시 자동 변경)          
```devtools.livereload.enabled=true```에 관한 설명 : https://m.blog.naver.com/spring1a/221757269099          
    
ID 와 Secret은 ```security.oauth2.client.registration.[소셜명]``` 경로로 프러퍼티 등록이 가능합니다.     
각 소셜 미디어별로 제공되는 ID 와 Secret을 등록합니다.    
만약 default 로 설정되어 있는 정보를 수정하고 싶다면 해당 프로퍼티를 기술하여 오버라이드하여 변경 할 수 있습니다.   
    
구글과 페이스북은 범용적인 소셜 그룹이라 시큐리티에서 제공하지만 카카오와 같이 국내에서만 사용하는 소셜은 어떻게 처리할까요?    
    
카카오는 살짝 편법을 사용하여 등록하겠습니다. (카카오를 처리하는 enum 을 만들어서 처리)     
OAuth2 API 에서 제공하는 방법과 동일하게 제공할 겁니다.   
     
1. ```com.web.oauth``` 디렉토리로 이동합니다.        
2. ```CustomOAuth2Provider``` enum 클래스를 생성해주고 아래와 같이 입력해줍니다.        
  
**CustomOAuth2Provider.enum**       
```java
package com.web.oauth;

import org.springframework.security.oauth2.client.registration.ClientRegistration;
import org.springframework.security.oauth2.core.AuthorizationGrantType;
import org.springframework.security.oauth2.core.ClientAuthenticationMethod;
import org.springframework.security.oauth2.core.oidc.IdTokenClaimNames;

public enum CustomOAuth2Provider {

    KAKAO {
        @Override
        public ClientRegistration.Builder getBuilder(String registrationId) {
            ClientRegistration.Builder builder = getBuilder(registrationId,
                    ClientAuthenticationMethod.POST, DEFAULT_LOGIN_REDIRECT_URL);
            builder.scope("profile");
            builder.authorizationUri("https://kauth.kakao.com/oauth/authorize");
            builder.tokenUri("https://kauth.kakao.com/oauth/token");
            builder.userInfoUri("https://kapi.kakao.com/v1/user/me");
            builder.userNameAttributeName("id");
            builder.clientName("Kakao");
            return builder;
        }
    };

    private static final String DEFAULT_LOGIN_REDIRECT_URL = "{baseUrl}/login/oauth2/code/{registrationId}";

    protected final ClientRegistration.Builder getBuilder(String registrationId,
                                                          ClientAuthenticationMethod method, String redirectUri) {
        ClientRegistration.Builder builder = ClientRegistration.withRegistrationId(registrationId);
        builder.clientAuthenticationMethod(method);
        builder.authorizationGrantType(AuthorizationGrantType.AUTHORIZATION_CODE);
        builder.redirectUriTemplate(redirectUri);
        return builder;
    }

    public abstract ClientRegistration.Builder getBuilder(String registrationId);
}
```
기존 ```CommonOAuth2Provider```의 형식을 그대로 가져와 만들었습니다.    
이제 위 코드를 이용하여 카카오의 OAuth2 로그인 정보를 빌더로 생성하여 재공할 수 있게 되었습니다.       
   
카카오는 클라이언트 ID 값만 필요하기 때문에 임의로 ```custom.oauth2.kakao.client-id``` 의 값을 참조할 수 있도록     
```application.yml``` 에 다음과 같은 프로퍼티를 추가해줍시다.    
    
**application.yml**    
```yml
custom:
  oauth2:
    kakao:
      client-id: [카카오 ID]   
```

**전체 application.yml**
```yml
spring:
  #  datasource:
  #    url: jdbc:mysql://
  #    username:
  #    password:
  #    driver-class-name: com.mysql.jdbc.Driver
  jpa:
    hibernate:
      ddl-auto: create
  h2:
    console:
      enabled: true
  devtools:
    livereload:
      enabled: true
  thymeleaf:
    cache: false
  security:
    oauth2:
      client:
        registration:
          google:
            client-id: [googleId]
            client-secret: [googleSecret]
          facebook:
            client-id: [facebookId]
            client-secret: [facebookSecret]
custom:
  oauth2:
    kakao:
      client-id: [카카오 ID] 	    
```
   
___    
    
이제 2.0 방식으로 시큐리티 + OAuth2 설정을 변경해보도록 하겠습니다.     
설정은 다음과 같이 수정하면 끝입니다.   

**SecurityConfig**
```java
package com.web.config;

import org.springframework.context.annotation.Configuration;
import org.springframework.security.config.annotation.web.builders.HttpSecurity;
import org.springframework.security.config.annotation.web.configuration.EnableWebSecurity;
import org.springframework.security.config.annotation.web.configuration.WebSecurityConfigurerAdapter;
import org.springframework.security.web.authentication.LoginUrlAuthenticationEntryPoint;
import org.springframework.security.web.csrf.CsrfFilter;
import org.springframework.web.filter.CharacterEncodingFilter;


import static com.web.domain.enums.SocialType.FACEBOOK;
import static com.web.domain.enums.SocialType.GOOGLE;
import static com.web.domain.enums.SocialType.KAKAO;

@Configuration
@EnableWebSecurity
public class SecurityConfig extends WebSecurityConfigurerAdapter {


    @Override
    protected void configure(HttpSecurity http) throws Exception {
        CharacterEncodingFilter filter = new CharacterEncodingFilter();

        http
                .authorizeRequests()
                    .antMatchers("/", "/oauth2/**", "/login/**", "/css/**", "/images/**", "/js/**", "/console/**", "/h2-console/**").permitAll()
                    .antMatchers("/facebook").hasAuthority(FACEBOOK.getRoleType())
                    .antMatchers("/google").hasAuthority(GOOGLE.getRoleType())
                    .antMatchers("/kakao").hasAuthority(KAKAO.getRoleType())
                    .anyRequest().authenticated()
                .and()
                    .oauth2Login()
                    .defaultSuccessUrl("/loginSuccess")
                    .failureUrl("/loginFailure")
                .and()
                    .headers().frameOptions().disable()
                .and()
                    .exceptionHandling()
                    .authenticationEntryPoint(new LoginUrlAuthenticationEntryPoint("/login"))
                .and()
                    .formLogin()
                    .successForwardUrl("/board/list")
                .and()
                    .logout()
                    .logoutUrl("/logout")
                    .logoutSuccessUrl("/")
                    .deleteCookies("JSESSIONID")
                    .invalidateHttpSession(true)
                .and()
                    .addFilterBefore(filter, CsrfFilter.class)
                    .csrf().disable();
    }
}
```
```java
                .and()
                    .oauth2Login()
                    .defaultSuccessUrl("/loginSuccess")
                    .failureUrl("/loginFailure")
```
이전에 비해 코드가 상당량 줄어든 것을 알 수 있습니다.            
단지 시큐리티 설정에서 ```oauth2Login()```만 추가로 설정하면 기본적으로 제공되는 구글과 페이스북에 대한 OAuth2 인증 방식이 적용됩니다.           
OAuth2 인증이 성공했다는 URI와 실패 했을 때의 URI를 ```defaultSuccessUrl()``` 과 ```failureUrl()``` 로 설정 가능합니다.       
OAuth2 API 에서 인증 요청되는 URI 가 ```/oauth2/**```를 갖기 때문에 모든 사용자에게 권한을 허용하도록 설정했습니다.       
      
구글과 페이스북에 대한 연동처리를 해주었으니 카카오 로그인도 연동시켜주도록 하겠습니다.         
원래는 시큐리티 스타터에서 자동으로 설정되는 부분이지만 카카오도 함께 설정되도록 하기 위해 다음과 같은 코드를 추가합니다.       
      
```java

```

## 1.2. 소 주제
### 1.2.1. 내용1
```
내용1
```

***
# 2. 대주제
> 인용
## 2.1. 소 주제
### 2.1.1. 내용1
```
내용1
```   

***
# 3. 대주제
> 인용
## 3.1. 소 주제
### 3.1.1. 내용1
```
내용1
```

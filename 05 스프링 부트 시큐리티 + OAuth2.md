05 스프링 부트 시큐리티 + OAuth2
=======================
스프링 부트 프레임워크는 인증과 권한에 관련된 강력한 기능인 **스프링 부트 시큐리티**를 제공합니다.         
스프링 부트 시큐리티는 스프링 시큐리티의 번거로운 설정을 간소화 시켜주는 **래핑 프레임워크**입니다.         
        
스프링 (부트) 시큐리티는 십여 년간 보안 노하우를 쌓아 와서    
**기본적인 틀 안에서 원하는 대로 인증, 권한 처리를 편리하게 관리할 수 있습니다.**         
따라서 보안 문제는 스프링 부트 시큐리티에 맡겨두고 우리는 핵심 로직만 개발하면 됩니다.          
      
일반적인 인증은 ID 와 PW 로 이루어집니다.         
반면 회원 가입 과정을 생략하고 빠른 인증을 제공하는 인증방식인 OAuth2도 많이 사용합니다.       
우리는 이 2가지 방법을 배울 것입니다.     
    
우리는 특별히 스프링 부트 1.5 버전에서의 스프링 부트 시큐리티부터 알아보겠습니다.         
```1.5 버전```에서 지원하는 시큐리티와 OAuth2 API를 사용해 소셜 미디어 인증을 빠르고 쉽게 적용하겠습니다.     
```2.0 버전```부터는 스프링 시큐리티 내부에 OAuth2 API가 포함되는 등 구조가 많이 바뀌었습니다.   
```1.5 버전```을 통해 전체적인 적용방식을 익히고 2.0 버전으로 어떻게 업그레이드 되는지 알아봅시다.   

[1. 배경지식 소개](#1-배경지식-소개)    
[2. 스프링 부트 시큐리티 + OAuth2 설계하기](#2-스프링-부트-시큐리티--oauth2-설계하기)    
* 스프링 부트 시큐리티 + OAuth2 의존성 설정하기   
* 스프링 부트 시큐리티 + OAuth2 구현하기 
* 스프링 부트 2.0 기반의 OAuth2 설정하기 

# 1. 배경지식 소개
스프링 부트 시큐리티는 **스프링 시큐리티에 스타터를 제공해 더 빠른 설정을 지원**하는 프로젝트입니다.           
빠르게 설정하고 적용하는 것도 중요하지만    
기본적으로 **시큐리티와 OAuth2가 무엇이며 어떻게 인증이 수행되는지 확실하게 이해해보겠습니다.**      
     
## 1.1. 스프링 부트 시큐리티  
스프링 부트 시큐리티에서 가장 중요한 개념은 **인증** 과 **권한 부여**입니다.      
* **인증 :**  사용자(클라이언트)가 애플리케이션의 특정 동작에 관하여 허락(인증)된 사용자인지 확인하는 절차    
* **권한 부여 :** 데이터나 프로그램 등의 특정 자원이나 서비스에 접근할 수 있는 권한을 허용하는 것  
       
전통적인 인증 방식으로 사용자명과 비밀번호로 인증하는 ```크리덴셜 기반 인증 방식```이 있습니다.       
OTP와 같이 추가적인 인증 방식을 도입해 한번에 2가지 방법으로 인증하는 ```이중 인증 방식```도 있습니다.       
소셜미디어를 사용해 편리하게 인증하는 ```OAuth2 인증 방식```도 최근에는 필수적으로 쓰이고 있습니다.       
    
## 1.2. OAuth2   
OAuth는 **토큰을 사용한 범용적인 방법의 인증을 제공**하는 표준 인증 프로토콜입니다.         
이 프로토콜은 서드파티를 위한 범용적인 인증 표준입니다.  
```
서드파티 : 제 3자라는 뜻, 여기서는 프로토콜이나 관련된 사항이 아닌 다른 리소스를 말합니다.   
```      
   
OAuth2에서 제공하는 승인 타입은 총 4가지 입니다.    

1. **권한 부여 코드 승인 타입(Authorization Code Grant Type) :**    
클라이언트가 다른 사용자 대신 특정 리소스에 접근을 요청할 때 사용됩니다.       
리소스 접근을 위한 사용자명과 비밀번호, 권한 서버에 요청해서 받은 권한 코드를 함께 활용하여     
리소스에 대한 액세스 토큰을 받으면 이를 인증에 이용하는 방식입니다.     
2. **암시적 승인 타입 (Implicit Grant Type) :**         
권한 부여 코드 승인 타입과 권한 코드 교환 단계 없이 액세스 토큰을 즉시 반환받아 이를 인증에 이용하는 방식입니다.     
3. **리소스 소유자 암호 자격 증명 승인 타입(Resource Owner Password Credentials Grant Type) :**      
클라이언트가 암호를 사용하여 액세스 토큰에 대한 사용자의 자격 증명을 교환하는 방식입니다.       
4. **클라이언트 자격 증명 승인 타입(Client Credentials Grant Type) :**      
클라이언트가 컨텍스트 외부에서 액세스 토큰을 얻어 특정 리소스에 접근을 요청할 때 사용하는 방식입니다.   
   
눈여겨볼 방식은 ```1. 권한 부여 코드 승인 타입(Authorization Code Grant Type)``` 입니다.   
왜냐하면 페이스북, 구글, 카카오 등의 소셜 미디어들이 웹 서버 형태의 클라이언트를 지원하는 데 이 방식을 사용하기 때문입니다.   
이 방식은 장기 액세스 토큰을 사용하여 사용자 인증을 처리합니다.   
   
[사진]     
         
위 시퀀스 다이어그램에 표시된 각 주체에 대한 예입니다.          
           
* 리소스 주인 : 인증이 필요한 사용자                   
* 클라이언트 : 웹사이트                      
* 권한 서버 : 페이스북/구글/카카오 서버                 
* 리소스 서버 : 페이스북/구글/카카오 서버               
         
1. 클라이언트가 파라미터로 **클라이언트 ID**, **리다이렉트 URI**, **응답 타입**을 코드(code)로 지정하여 권한 서버에 전달합니다.       
정상적으로 인증이 되면 권한 부여 코드를 클라이언트에 보냅니다.   
(응답 타입은 code, token이 사용가능합니다. 응답 타입이 token 일 때가 암시적 승인 타입에 해당합니다.)    
   
2. 성공적으로 권한 부여 코드를 받은 클라이언트는 권한 부여 코드를 사용하여 액세스 토큰을 권한 서버에 추가로 요청합니다.    
이때 필요한 파라미터는 **클라이언트 ID**, **클라이언트 비밀번호**, **리다이렉트 URI**, **인증 타입**입니다.  
   
3. 마지막으로 응답받은 액세스 토큰을 사용하여 리소스 서버에 사용자의 데이터를 요청합니다.  

즉, ```클라이언트 ID로 SNS 응답``` -> ```ID/PW 로 인증``` -> ```인증 받은 후 필요한 데이터 요청```   
   
```사용자명 + 비밀번호``` 인증 방식은 저장된 사용자명과 비밀번호가 같은지 한 번만 요청하면 되지만 **OAuth2 방식은 최소 3번 요청합니다.**  
하지만 ```OAuth2```는 회원 가입 없이 이미 사용하는 소셜 미디어 계정으로 인증하기 때문에       
사용자 입장에서는 더욱 편리하게 로그인 처리할 수 있습니다.   
서비스 측면에서는 회원 가입 관련 기능을 축소키시고 소셜에서 제공하는 User 정보를 가져올 수 있어 편리합니다.   
     
여기서 ```권한 부여 코드 승인 타입```의 흐름을 이해하는 것은 굉장히 중요합니다.   
스프링이 아닌 다른 어떤 라이브러리도 이 흐름을 바탕으로 코드를 구현하기 때문에    
정확히 파악하는 것만으로도 소셜 인증 구현을 위한 준비 중 절반을 진행했다고 해도 과언이 아닙니다.   

***
# 2. 스프링 부트 시큐리티 + OAuth2 설계하기  
> 인용
## 2.1. 소 주제
### 2.1.1. 내용1
```
내용1
```   

***
# 3. 대주제
> 인용
## 3.1. 소 주제
### 3.1.1. 내용1
```
내용1
```
